# ç»Ÿä¸€é€šå…³æµæ°´çº¿é›†æˆæŒ‡å—

## âœ… å·²å®Œæˆçš„æ”¹åŠ¨

### ğŸ”§ åç«¯æ”¹åŠ¨ï¼ˆNestJSï¼‰

#### 1. åˆ¤é¢˜æœåŠ¡å‡çº§

**æ–‡ä»¶**: `server/api/src/modules/judge/judge.service.ts`

âœ… **æ–°å¢åŠŸèƒ½**:

- æ–°å¢ `stdout_compare` åˆ¤é¢˜ç±»å‹ï¼ˆæ”¯æŒæ‰“å°ç±»é¢˜ç›®ï¼‰
- ç»Ÿä¸€è¿”å›æ ¼å¼ï¼š`{ pass, message, details }`
- æ”¹è¿›æ¶ˆæ¯æç¤ºï¼ˆä¸­æ–‡å‹å¥½ï¼‰

âœ… **æ”¯æŒçš„åˆ¤é¢˜ç±»å‹**:
| ç±»å‹ | é€‚ç”¨æ¸¸æˆ | è¯´æ˜ |
|------|----------|------|
| `api_events` | è¿·å®«å¯¼èˆª | æ£€æµ‹æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹ã€æ­¥æ•°é™åˆ¶ |
| `svg_path_similarity` | æµ·é¾Ÿç”»å®¶ | æ¯”å¯¹è·¯å¾„æ®µæ•° |
| `unit_tests` | ç®—æ³•åˆ†æ‹£ | ç»“æœå¯¹æ¯” |
| `stdout_compare` | **æ–°å¢** æ‰“å°é¢˜ | è¾“å‡ºæ¯”å¯¹ï¼ˆæ”¯æŒ exact/lines/regex æ¨¡å¼ï¼‰ |

#### 2. è¿›åº¦ç®¡ç†æ¨¡å—

**æ–‡ä»¶**:

- `server/api/src/modules/progress/progress.service.ts`
- `server/api/src/modules/progress/progress.controller.ts`
- `server/api/src/modules/progress/progress.module.ts`

âœ… **æ–°å¢ API**:

```
POST /api/progress/update
GET  /api/progress/next?userId=demo&language=python&game=maze_navigator
GET  /api/progress/status?userId=demo&language=python&game=maze_navigator
```

âœ… **åŠŸèƒ½**:

- è®°å½•ç”¨æˆ·é€šå…³è¿›åº¦
- è®¡ç®—ä¸‹ä¸€å…³
- æŸ¥è¯¢è¿›åº¦çŠ¶æ€

#### 3. AppModule æ³¨å†Œ

âœ… å·²åœ¨ `server/api/src/app.module.ts` ä¸­æ³¨å†Œ `ProgressModule`

---

### ğŸ¨ å‰ç«¯æ”¹åŠ¨

#### 1. Progress API æœåŠ¡

**æ–‡ä»¶**: `apps/student-app/src/services/progress.ts`

âœ… **æ–°å¢å‡½æ•°**:

- `updateProgress()` - æ›´æ–°é€šå…³è¿›åº¦
- `getNextLevel()` - è·å–ä¸‹ä¸€å…³ä¿¡æ¯
- `getProgressStatus()` - æŸ¥è¯¢è¿›åº¦çŠ¶æ€

#### 2. RunPanel ç»„ä»¶

**æ–‡ä»¶**: `apps/student-app/src/components/RunPanel.tsx`

âœ… **å·²æœ‰åŠŸèƒ½**:

- æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ
- ä¸€é”®ç²˜è´´åˆ°ç¼–è¾‘å™¨
- é€šå…³åæ˜¾ç¤º"è¿›å…¥ä¸‹ä¸€å…³"æŒ‰é’®

---

## ğŸ“‹ å¦‚ä½•é…ç½®å…³å¡ JSON

### ç¤ºä¾‹ 1ï¼šæ‰“å°é¢˜ï¼ˆFor å¾ªç¯æ‰“å° 1-5ï¼‰

```json
{
  "level": 1,
  "title": "å¾ªç¯æ‰“å° 1..5",
  "gameType": "io",
  "starter": {
    "code": "for i in range(1, 6):\n    pass\n"
  },
  "solution": "for i in range(1, 6):\n    print(i)\n",
  "judge": {
    "type": "stdout_compare",
    "criteria": {
      "mode": "lines",
      "expected": "1\n2\n3\n4\n5"
    }
  }
}
```

### ç¤ºä¾‹ 2ï¼šè¿·å®«å¯¼èˆª

```json
{
  "level": 1,
  "title": "å‘å‰ä¸€æ­¥",
  "gameType": "maze",
  "starter": {
    "code": "def solve(api):\n    pass\n"
  },
  "solution": "def solve(api):\n    api.move_forward(1)\n",
  "judge": {
    "type": "api_events",
    "criteria": {
      "max_steps": 20,
      "end_state": "REACHED"
    }
  }
}
```

### ç¤ºä¾‹ 3ï¼šæµ·é¾Ÿç”»å®¶

```json
{
  "level": 1,
  "title": "ç”»æ­£æ–¹å½¢",
  "gameType": "turtle",
  "starter": {
    "code": "# ç”»ä¸€ä¸ªè¾¹é•¿ä¸º 100 çš„æ­£æ–¹å½¢\n"
  },
  "solution": "for i in range(4):\n    forward(100)\n    right(90)\n",
  "judge": {
    "type": "svg_path_similarity",
    "criteria": {
      "segments": 4,
      "tolerance": 0.1
    }
  }
}
```

### ç¤ºä¾‹ 4ï¼šåƒç´ å›¾ï¼ˆ5x5 ç¬‘è„¸ï¼‰

```json
{
  "level": 1,
  "title": "5x5 ç¬‘è„¸",
  "gameType": "pixel",
  "starter": {
    "code": "canvas = [[0]*5 for _ in range(5)]\n# TODO: å¡«å……ç¬‘è„¸\n"
  },
  "solution": "canvas = [[0]*5 for _ in range(5)]\ncanvas[1][1] = 1\ncanvas[1][3] = 1\ncanvas[3][1] = 1\ncanvas[3][2] = 1\ncanvas[3][3] = 1\n",
  "judge": {
    "type": "stdout_compare",
    "criteria": {
      "mode": "lines",
      "expected": "0 1 0 1 0\n0 0 0 0 0\n0 1 1 1 0\n..."
    }
  }
}
```

---

## ğŸ”§ stdout_compare åˆ¤é¢˜æ¨¡å¼è¯´æ˜

### mode: "exact" ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰

```json
{
  "type": "stdout_compare",
  "criteria": {
    "mode": "exact",
    "expected": "Hello World"
  }
}
```

- è¾“å‡ºå¿…é¡»å®Œå…¨ä¸€è‡´ï¼ˆå¿½ç•¥è¡Œå°¾ç©ºæ ¼å’Œ Windows/Unix æ¢è¡Œç¬¦å·®å¼‚ï¼‰

### mode: "lines" ï¼ˆæŒ‰è¡ŒåŒ¹é…ï¼‰

```json
{
  "type": "stdout_compare",
  "criteria": {
    "mode": "lines",
    "expected": "1\n2\n3\n4\n5"
  }
}
```

- æ¯è¡Œåˆ†åˆ«æ¯”è¾ƒ
- å¿½ç•¥è¡Œå°¾ç©ºæ ¼
- ç»Ÿä¸€å¤„ç†æ¢è¡Œç¬¦

### mode: "regex" ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰

```json
{
  "type": "stdout_compare",
  "criteria": {
    "mode": "regex",
    "expected": "^[0-9]+$"
  }
}
```

- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼éªŒè¯è¾“å‡º

---

## ğŸš€ æµ‹è¯•æµç¨‹

### 1. é‡å¯æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰è¿›ç¨‹
Get-Process | Where-Object {$_.ProcessName -eq "node"} | Stop-Process -Force

# å¯åŠ¨æœåŠ¡
cd F:\project\kids-coding-platform
.\start-studyrunner-test.ps1
```

### 2. æµ‹è¯•åˆ¤é¢˜ API

```bash
# æµ‹è¯• stdout_compare
curl -X POST http://localhost:3000/api/judge \
  -H "Content-Type: application/json" \
  -d '{
    "type": "stdout_compare",
    "criteria": { "mode": "lines", "expected": "1\n2\n3\n4\n5" },
    "payload": { "stdout": "1\n2\n3\n4\n5" }
  }'

# é¢„æœŸå“åº”
{
  "pass": true,
  "message": "è¾“å‡ºå®Œå…¨æ­£ç¡®ï¼",
  "details": { "mode": "lines", "expected": "1\n2\n3\n4\n5", "actual": "1\n2\n3\n4\n5" }
}
```

### 3. æµ‹è¯•è¿›åº¦ API

```bash
# æ›´æ–°è¿›åº¦
curl -X POST http://localhost:3000/api/progress/update \
  -H "Content-Type: application/json" \
  -d '{ "userId": "demo", "language": "python", "game": "maze_navigator", "level": 1 }'

# è·å–ä¸‹ä¸€å…³
curl "http://localhost:3000/api/progress/next?userId=demo&language=python&game=maze_navigator"

# é¢„æœŸå“åº”
{
  "nextLevel": 2,
  "finished": false,
  "currentLevel": 1
}
```

### 4. æµè§ˆå™¨æµ‹è¯•

è®¿é—®ï¼š`http://localhost:5173/play/python-io-loops-1`

**æµ‹è¯•æ­¥éª¤**ï¼š

1. ç¼–å†™ä»£ç 
2. ç‚¹å‡» "â–¶ï¸ è¿è¡Œä»£ç "
3. æŸ¥çœ‹åˆ¤é¢˜ç»“æœ
4. å¦‚æœæœªé€šè¿‡ â†’ ç‚¹å‡» "ğŸ’¡ æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ"
5. å¦‚æœé€šè¿‡ â†’ ç‚¹å‡» "è¿›å…¥ä¸‹ä¸€å…³ â†’"

---

## ğŸ“Š åˆ¤é¢˜è§„åˆ™å¯¹ç…§è¡¨

| æ¸¸æˆç±»å‹ | judge.type            | å‰ç«¯æäº¤ payload                            | åç«¯åˆ¤æ–­é€»è¾‘              |
| -------- | --------------------- | ------------------------------------------- | ------------------------- |
| è¿·å®«     | `api_events`          | `{ meta: {reached, steps}, events: [...] }` | æ£€æŸ¥ reached å’Œ max_steps |
| æµ·é¾Ÿ     | `svg_path_similarity` | `{ segments: [{len, deg}, ...] }`           | æ®µæ•°å·®å€¼ â‰¤ 1              |
| åˆ†æ‹£     | `unit_tests`          | `{ result, expected }`                      | JSON ç›¸ç­‰                 |
| æ‰“å°     | `stdout_compare`      | `{ stdout: "..." }`                         | æŒ‰æ¨¡å¼æ¯”è¾ƒè¾“å‡º            |

---

## ğŸ¯ ä¸‹ä¸€æ­¥é›†æˆå»ºè®®

### 1. æ›´æ–°ç°æœ‰å…³å¡ JSON

å°†ç°æœ‰çš„å…³å¡æ–‡ä»¶ï¼ˆå¦‚ `python-io-loops-1.json`ï¼‰æ·»åŠ  `judge` å­—æ®µï¼š

```json
{
  "judge": {
    "type": "stdout_compare",
    "criteria": {
      "mode": "lines",
      "expected": "æœŸæœ›è¾“å‡ºå†…å®¹"
    }
  }
}
```

### 2. çœŸå®æ‰§è¡Œå™¨é›†æˆ

å½“å‰ RunPanel ä½¿ç”¨çš„æ˜¯ mock çš„ `runAndJudge`ã€‚è¦çœŸæ­£ä½¿ç”¨åç«¯åˆ¤é¢˜ï¼š

**æ–¹æ¡ˆ A**: ä¿®æ”¹ `runAndJudge.ts` è°ƒç”¨çœŸå® API

```typescript
// apps/student-app/src/lib/runAndJudge.ts
import { execute } from '../services/judge';
import { judge as judgeApi } from '../services/judge';

export async function runAndJudge({ level, code }: RunAndJudgeOptions) {
  // 1. æ‰§è¡Œä»£ç 
  const execResult = await execute({ language: level.lang, code });

  // 2. åˆ¤é¢˜
  const judgeResult = await judgeApi({
    type: level.judge?.type || 'stdout_compare',
    criteria: level.judge?.criteria || {},
    payload: { stdout: execResult.stdout },
  });

  return {
    exec: execResult,
    judge: {
      passed: judgeResult.pass,
      message: judgeResult.message,
      details: judgeResult.details,
    },
    // ...
  };
}
```

**æ–¹æ¡ˆ B**: ç›´æ¥åœ¨ RunPanel ä¸­è°ƒç”¨ APIï¼ˆæ¨èï¼‰

- æ›´çµæ´»
- æ›´å¥½çš„é”™è¯¯å¤„ç†
- å¯ä»¥åˆ†æ­¥æ˜¾ç¤ºæ‰§è¡Œå’Œåˆ¤é¢˜çŠ¶æ€

### 3. é›†æˆè¿›åº¦æ›´æ–°

åœ¨ RunPanel çš„ `handleRun` æˆåŠŸåï¼š

```typescript
if (result.judge.passed) {
  // æå–å…³å¡ä¿¡æ¯ï¼ˆä» level.id æˆ–å…¶ä»–å­—æ®µï¼‰
  await updateProgress({
    language: 'python', // ä» level ä¸­è·å–
    game: 'io', // ä» level.gameType
    level: 1, // ä» level.level
    durationMs: result.exec.durationMs,
  });

  // æ˜¾ç¤º"ä¸‹ä¸€å…³"æŒ‰é’®
  setShowNextButton(true);
}
```

### 4. ä¸‹ä¸€å…³å¯¼èˆª

```typescript
async function handleGoNext() {
  const { nextLevel } = await getNextLevel({
    language: 'python',
    game: 'io',
  });

  // è·³è½¬åˆ°ä¸‹ä¸€å…³
  navigate(`/play/python-io-level-${nextLevel}`);
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: åˆ¤é¢˜æ€»æ˜¯è¿”å› falseï¼Ÿ

A: æ£€æŸ¥å…³å¡ JSON çš„ `judge.type` å’Œ `criteria` æ˜¯å¦æ­£ç¡®é…ç½®ã€‚

### Q: stdout_compare ä¸åŒ¹é…ï¼Ÿ

A: ä½¿ç”¨ `mode: "lines"` è€Œä¸æ˜¯ `"exact"`ï¼Œæ›´å®¹æ˜“é€šè¿‡ã€‚

### Q: å¦‚ä½•è°ƒè¯•åˆ¤é¢˜é€»è¾‘ï¼Ÿ

A: æŸ¥çœ‹è¿”å›çš„ `details` å­—æ®µï¼ŒåŒ…å« expected å’Œ actual çš„å¯¹æ¯”ã€‚

### Q: è¿›åº¦ä¸ä¿å­˜ï¼Ÿ

A: å½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œé‡å¯åä¼šä¸¢å¤±ã€‚åç»­å¯æ¥å…¥æ•°æ®åº“ã€‚

---

## ğŸ“– ç›¸å…³æ–‡ä»¶

**åç«¯**:

- `server/api/src/modules/judge/judge.service.ts` - åˆ¤é¢˜é€»è¾‘
- `server/api/src/modules/progress/` - è¿›åº¦ç®¡ç†
- `server/api/src/modules/curriculum/` - å…³å¡æ•°æ®

**å‰ç«¯**:

- `apps/student-app/src/components/RunPanel.tsx` - è¿è¡Œé¢æ¿
- `apps/student-app/src/services/progress.ts` - è¿›åº¦ API
- `apps/student-app/src/lib/runAndJudge.ts` - åˆ¤é¢˜é›†æˆç‚¹

**æ•°æ®**:

- `server/api/src/data/curriculum/` - å…³å¡ JSON
- `apps/student-app/public/levels/` - å‰ç«¯å…³å¡æ•°æ®

---

**çŠ¶æ€**: âœ… åç«¯å®Œæˆï¼Œå‰ç«¯åŸºç¡€é›†æˆå®Œæˆ  
**ä¸‹ä¸€æ­¥**: é…ç½®å…³å¡ JSONï¼Œæµ‹è¯•åˆ¤é¢˜æµç¨‹  
**æ–‡æ¡£æ›´æ–°**: 2025-10-07
