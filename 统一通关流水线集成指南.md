# 统一通关流水线集成指南

## ✅ 已完成的改动

### 🔧 后端改动（NestJS）

#### 1. 判题服务升级

**文件**: `server/api/src/modules/judge/judge.service.ts`

✅ **新增功能**:

- 新增 `stdout_compare` 判题类型（支持打印类题目）
- 统一返回格式：`{ pass, message, details }`
- 改进消息提示（中文友好）

✅ **支持的判题类型**:
| 类型 | 适用游戏 | 说明 |
|------|----------|------|
| `api_events` | 迷宫导航 | 检测是否到达终点、步数限制 |
| `svg_path_similarity` | 海龟画家 | 比对路径段数 |
| `unit_tests` | 算法分拣 | 结果对比 |
| `stdout_compare` | **新增** 打印题 | 输出比对（支持 exact/lines/regex 模式） |

#### 2. 进度管理模块

**文件**:

- `server/api/src/modules/progress/progress.service.ts`
- `server/api/src/modules/progress/progress.controller.ts`
- `server/api/src/modules/progress/progress.module.ts`

✅ **新增 API**:

```
POST /api/progress/update
GET  /api/progress/next?userId=demo&language=python&game=maze_navigator
GET  /api/progress/status?userId=demo&language=python&game=maze_navigator
```

✅ **功能**:

- 记录用户通关进度
- 计算下一关
- 查询进度状态

#### 3. AppModule 注册

✅ 已在 `server/api/src/app.module.ts` 中注册 `ProgressModule`

---

### 🎨 前端改动

#### 1. Progress API 服务

**文件**: `apps/student-app/src/services/progress.ts`

✅ **新增函数**:

- `updateProgress()` - 更新通关进度
- `getNextLevel()` - 获取下一关信息
- `getProgressStatus()` - 查询进度状态

#### 2. RunPanel 组件

**文件**: `apps/student-app/src/components/RunPanel.tsx`

✅ **已有功能**:

- 查看参考答案
- 一键粘贴到编辑器
- 通关后显示"进入下一关"按钮

---

## 📋 如何配置关卡 JSON

### 示例 1：打印题（For 循环打印 1-5）

```json
{
  "level": 1,
  "title": "循环打印 1..5",
  "gameType": "io",
  "starter": {
    "code": "for i in range(1, 6):\n    pass\n"
  },
  "solution": "for i in range(1, 6):\n    print(i)\n",
  "judge": {
    "type": "stdout_compare",
    "criteria": {
      "mode": "lines",
      "expected": "1\n2\n3\n4\n5"
    }
  }
}
```

### 示例 2：迷宫导航

```json
{
  "level": 1,
  "title": "向前一步",
  "gameType": "maze",
  "starter": {
    "code": "def solve(api):\n    pass\n"
  },
  "solution": "def solve(api):\n    api.move_forward(1)\n",
  "judge": {
    "type": "api_events",
    "criteria": {
      "max_steps": 20,
      "end_state": "REACHED"
    }
  }
}
```

### 示例 3：海龟画家

```json
{
  "level": 1,
  "title": "画正方形",
  "gameType": "turtle",
  "starter": {
    "code": "# 画一个边长为 100 的正方形\n"
  },
  "solution": "for i in range(4):\n    forward(100)\n    right(90)\n",
  "judge": {
    "type": "svg_path_similarity",
    "criteria": {
      "segments": 4,
      "tolerance": 0.1
    }
  }
}
```

### 示例 4：像素图（5x5 笑脸）

```json
{
  "level": 1,
  "title": "5x5 笑脸",
  "gameType": "pixel",
  "starter": {
    "code": "canvas = [[0]*5 for _ in range(5)]\n# TODO: 填充笑脸\n"
  },
  "solution": "canvas = [[0]*5 for _ in range(5)]\ncanvas[1][1] = 1\ncanvas[1][3] = 1\ncanvas[3][1] = 1\ncanvas[3][2] = 1\ncanvas[3][3] = 1\n",
  "judge": {
    "type": "stdout_compare",
    "criteria": {
      "mode": "lines",
      "expected": "0 1 0 1 0\n0 0 0 0 0\n0 1 1 1 0\n..."
    }
  }
}
```

---

## 🔧 stdout_compare 判题模式说明

### mode: "exact" （精确匹配）

```json
{
  "type": "stdout_compare",
  "criteria": {
    "mode": "exact",
    "expected": "Hello World"
  }
}
```

- 输出必须完全一致（忽略行尾空格和 Windows/Unix 换行符差异）

### mode: "lines" （按行匹配）

```json
{
  "type": "stdout_compare",
  "criteria": {
    "mode": "lines",
    "expected": "1\n2\n3\n4\n5"
  }
}
```

- 每行分别比较
- 忽略行尾空格
- 统一处理换行符

### mode: "regex" （正则匹配）

```json
{
  "type": "stdout_compare",
  "criteria": {
    "mode": "regex",
    "expected": "^[0-9]+$"
  }
}
```

- 使用正则表达式验证输出

---

## 🚀 测试流程

### 1. 重启服务

```bash
# 停止所有进程
Get-Process | Where-Object {$_.ProcessName -eq "node"} | Stop-Process -Force

# 启动服务
cd F:\project\kids-coding-platform
.\start-studyrunner-test.ps1
```

### 2. 测试判题 API

```bash
# 测试 stdout_compare
curl -X POST http://localhost:3000/api/judge \
  -H "Content-Type: application/json" \
  -d '{
    "type": "stdout_compare",
    "criteria": { "mode": "lines", "expected": "1\n2\n3\n4\n5" },
    "payload": { "stdout": "1\n2\n3\n4\n5" }
  }'

# 预期响应
{
  "pass": true,
  "message": "输出完全正确！",
  "details": { "mode": "lines", "expected": "1\n2\n3\n4\n5", "actual": "1\n2\n3\n4\n5" }
}
```

### 3. 测试进度 API

```bash
# 更新进度
curl -X POST http://localhost:3000/api/progress/update \
  -H "Content-Type: application/json" \
  -d '{ "userId": "demo", "language": "python", "game": "maze_navigator", "level": 1 }'

# 获取下一关
curl "http://localhost:3000/api/progress/next?userId=demo&language=python&game=maze_navigator"

# 预期响应
{
  "nextLevel": 2,
  "finished": false,
  "currentLevel": 1
}
```

### 4. 浏览器测试

访问：`http://localhost:5173/play/python-io-loops-1`

**测试步骤**：

1. 编写代码
2. 点击 "▶️ 运行代码"
3. 查看判题结果
4. 如果未通过 → 点击 "💡 查看参考答案"
5. 如果通过 → 点击 "进入下一关 →"

---

## 📊 判题规则对照表

| 游戏类型 | judge.type            | 前端提交 payload                            | 后端判断逻辑              |
| -------- | --------------------- | ------------------------------------------- | ------------------------- |
| 迷宫     | `api_events`          | `{ meta: {reached, steps}, events: [...] }` | 检查 reached 和 max_steps |
| 海龟     | `svg_path_similarity` | `{ segments: [{len, deg}, ...] }`           | 段数差值 ≤ 1              |
| 分拣     | `unit_tests`          | `{ result, expected }`                      | JSON 相等                 |
| 打印     | `stdout_compare`      | `{ stdout: "..." }`                         | 按模式比较输出            |

---

## 🎯 下一步集成建议

### 1. 更新现有关卡 JSON

将现有的关卡文件（如 `python-io-loops-1.json`）添加 `judge` 字段：

```json
{
  "judge": {
    "type": "stdout_compare",
    "criteria": {
      "mode": "lines",
      "expected": "期望输出内容"
    }
  }
}
```

### 2. 真实执行器集成

当前 RunPanel 使用的是 mock 的 `runAndJudge`。要真正使用后端判题：

**方案 A**: 修改 `runAndJudge.ts` 调用真实 API

```typescript
// apps/student-app/src/lib/runAndJudge.ts
import { execute } from '../services/judge';
import { judge as judgeApi } from '../services/judge';

export async function runAndJudge({ level, code }: RunAndJudgeOptions) {
  // 1. 执行代码
  const execResult = await execute({ language: level.lang, code });

  // 2. 判题
  const judgeResult = await judgeApi({
    type: level.judge?.type || 'stdout_compare',
    criteria: level.judge?.criteria || {},
    payload: { stdout: execResult.stdout },
  });

  return {
    exec: execResult,
    judge: {
      passed: judgeResult.pass,
      message: judgeResult.message,
      details: judgeResult.details,
    },
    // ...
  };
}
```

**方案 B**: 直接在 RunPanel 中调用 API（推荐）

- 更灵活
- 更好的错误处理
- 可以分步显示执行和判题状态

### 3. 集成进度更新

在 RunPanel 的 `handleRun` 成功后：

```typescript
if (result.judge.passed) {
  // 提取关卡信息（从 level.id 或其他字段）
  await updateProgress({
    language: 'python', // 从 level 中获取
    game: 'io', // 从 level.gameType
    level: 1, // 从 level.level
    durationMs: result.exec.durationMs,
  });

  // 显示"下一关"按钮
  setShowNextButton(true);
}
```

### 4. 下一关导航

```typescript
async function handleGoNext() {
  const { nextLevel } = await getNextLevel({
    language: 'python',
    game: 'io',
  });

  // 跳转到下一关
  navigate(`/play/python-io-level-${nextLevel}`);
}
```

---

## 🐛 常见问题

### Q: 判题总是返回 false？

A: 检查关卡 JSON 的 `judge.type` 和 `criteria` 是否正确配置。

### Q: stdout_compare 不匹配？

A: 使用 `mode: "lines"` 而不是 `"exact"`，更容易通过。

### Q: 如何调试判题逻辑？

A: 查看返回的 `details` 字段，包含 expected 和 actual 的对比。

### Q: 进度不保存？

A: 当前使用内存存储，重启后会丢失。后续可接入数据库。

---

## 📖 相关文件

**后端**:

- `server/api/src/modules/judge/judge.service.ts` - 判题逻辑
- `server/api/src/modules/progress/` - 进度管理
- `server/api/src/modules/curriculum/` - 关卡数据

**前端**:

- `apps/student-app/src/components/RunPanel.tsx` - 运行面板
- `apps/student-app/src/services/progress.ts` - 进度 API
- `apps/student-app/src/lib/runAndJudge.ts` - 判题集成点

**数据**:

- `server/api/src/data/curriculum/` - 关卡 JSON
- `apps/student-app/public/levels/` - 前端关卡数据

---

**状态**: ✅ 后端完成，前端基础集成完成  
**下一步**: 配置关卡 JSON，测试判题流程  
**文档更新**: 2025-10-07
