# 关卡设计要求 - 快速参考

> 📖 完整文档请参考：[docs/level-design-principles.md](./docs/level-design-principles.md)

## 🚨 强制性要求

### 1. 关卡数量
- **每个游戏类型必须有恰好10个关卡**
- 编号格式：`{gameType}-###.json`（如：`io-001.json`, `led-010.json`）

### 2. 难度分布
- 初级（1-3关）：基础概念
- 中级（4-6关）：综合应用  
- 高级（7-9关）：复杂逻辑
- 挑战（10关）：创新思维

### 3. 必备元素
每个关卡JSON必须包含：
- ✅ `id` - 唯一标识符
- ✅ `title` - 吸引人的标题
- ✅ `gameType` - 游戏类型（io|pixel|music|maze|led）
- ✅ `difficulty` - 难度等级（1-10）
- ✅ `goals` - 学习目标数组
- ✅ `starter.code` - 包含TODO注释的初始代码
- ✅ `grader` - 判题配置
- ✅ `rewards` - 奖励配置（xp, coins, badges）

### 4. 期望结果 vs 实际结果
- **I/O类**：`grader.io.cases[].out` 定义期望输出
- **像素类**：预定义像素矩阵 vs 学生生成矩阵
- **音乐类**：预定义音乐事件序列 vs 学生生成序列
- **迷宫类**：到达终点路径 vs 学生控制路径
- **LED类**：预定义LED状态序列 vs 学生控制状态

### 5. 通关逻辑要求 ⚠️ 
**核心原则：错误答案绝对不能通关**

#### 判题逻辑严格性
- **必须实现精确匹配**：期望结果与实际结果必须完全一致
- **不允许宽松判题**：不能仅检查代码是否存在就通过

#### 参考答案验证流程 🔍
**为防止参考答案与期望结果不匹配的问题，必须执行以下验证流程：**

1. **创建关卡后立即验证**
   - 运行参考答案代码，获取实际输出
   - 对比实际输出与grader中定义的期望输出
   - 确保两者完全匹配

2. **使用自动化验证脚本**
   ```bash
   # 在项目根目录运行
   python validate_reference_solutions.py "apps/student-app/public/levels"
   ```

3. **验证脚本功能**
   - 自动扫描所有关卡JSON文件
   - 执行每个关卡的solution代码
   - 对比输出与grader.io.cases[].out
   - 生成详细的验证报告

4. **修复不匹配问题**
   - 如果参考答案输出与期望结果不匹配
   - 优先修正参考答案代码逻辑
   - 如果参考答案逻辑正确，则更新期望结果
   - 重新验证确保匹配

5. **持续验证要求**
   - 每次修改关卡配置后必须重新验证
   - 新增关卡前必须通过验证
   - 定期运行验证脚本确保一致性

#### 各游戏类型验证要点
- **事件序列验证**：对于事件类游戏，必须验证事件的完整性和顺序

#### 各游戏类型判题要求
- **IO类**：严格比较期望输出与实际输出，包括格式、内容、换行符
- **Pixel类**：像素矩阵必须完全匹配，不允许部分匹配
- **Music类**：音乐事件序列必须完全匹配，包括音符、时间、时值
- **Maze类**：必须验证是否到达终点且步数在限制内
- **LED类**：LED状态序列或最终输出必须完全匹配

#### 下一关按钮显示条件
```typescript
result?.judge?.passed && nextLevelId && onGoNext
```
- ✅ 判题通过（`result.judge.passed === true`）
- ✅ 存在下一关（`nextLevelId`）
- ✅ 回调函数存在（`onGoNext`）

**⚠️ 重要**：只有当学生的答案完全正确时，`result.judge.passed` 才会为 `true`，错误或不完整的答案必须返回 `false`。

### 6. 判题实现检查清单
在实现或修改判题逻辑时，必须确保：
- [ ] 空代码返回 `passed: false`
- [ ] 错误答案返回 `passed: false`
- [ ] 部分正确答案返回 `passed: false`
- [ ] 完全正确答案返回 `passed: true`
- [ ] 提供清晰的错误信息和期望vs实际对比
- [ ] 事件类游戏验证事件序列的完整性和顺序

## 📋 质量检查清单

创建新关卡前必须检查：
- [ ] 关卡ID唯一且格式正确
- [ ] 标题简洁有吸引力
- [ ] 目标明确且可测量
- [ ] 初始代码包含TODO注释
- [ ] 测试用例覆盖主要场景
- [ ] 期望结果和实际结果对比清晰
- [ ] 难度评级准确
- [ ] 奖励配置合理
- [ ] 学习提示有用且完整
- [ ] 通过 `npm run levels:check` 验证

## 🎯 当前状态

所有游戏类型已达到要求：
- ✅ **io**: 10个关卡
- ✅ **pixel**: 10个关卡  
- ✅ **music**: 10个关卡
- ✅ **maze**: 10个关卡
- ✅ **led**: 10个关卡

---

**⚠️ 重要提醒**：此文件为强制性要求的快速参考。所有新关卡必须严格遵守这些原则，确保用户体验的一致性和教育效果。