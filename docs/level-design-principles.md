# 关卡设计原则

## 🎯 核心原则

每个游戏关卡必须遵循以下设计原则，确保用户体验的一致性和教育效果：

### 1. 关卡数量要求
- **每个游戏类型必须有10个关卡**
- 关卡编号格式：`{gameType}-###.json`（如：`io-001.json`, `pixel-010.json`）
- 难度分布：
  - 初级（1-3关）：基础概念
  - 中级（4-6关）：综合应用
  - 高级（7-9关）：复杂逻辑
  - 挑战（10关）：创新思维

### 2. 关卡必备元素

每个关卡文件必须包含以下元素：

```json
{
  "id": "py-{gameType}-###",           // 唯一标识符
  "title": "关卡标题",                 // 吸引人的标题
  "lang": "python",                    // 编程语言
  "gameType": "{io|pixel|music|maze|led}", // 游戏类型
  "difficulty": 1-10,                  // 难度等级（1-10）
  "story": "背景故事",                 // 情境化描述
  "goals": ["目标1", "目标2"],         // 学习目标
  "starter": {                         // 初始代码
    "blockly": "<xml/>",               // Blockly代码
    "code": "# Python代码"              // Python代码
  },
  "grader": {                          // 判题配置
    "mode": "io|event|exact",         // 判题模式
    "io": {                            // I/O测试用例（io模式）
      "cases": [{"in": "", "out": ""}], // 输入输出用例
      "match": "exact|contains"         // 匹配模式
    },
    "constraints": {                   // 约束条件
      "maxTimeMs": 3000,               // 最大运行时间
      "maxMemMB": 64,                  // 最大内存使用
      "forbiddenImports": []           // 禁止导入的模块
    }
  },
  "rewards": {                         // 奖励配置
    "xp": 10-100,                      // 经验值（根据难度）
    "coins": 5-50,                     // 金币（根据难度）
    "badges": ["徽章名称"]              // 获得的徽章
  },
  "hints": ["提示1", "提示2"]          // 学习提示
}
```

### 3. 期望结果 vs 实际结果设计

#### I/O类游戏（io）
- **期望结果**：在`grader.io.cases[].out`中明确定义
- **实际结果**：学生代码的输出结果
- **判题逻辑**：`testCase.actual === testCase.expected`
- **展示方式**：在RunFeedback组件中显示输入、期望输出、实际输出的对比

#### 像素类游戏（pixel）
- **期望结果**：预定义的像素矩阵
- **实际结果**：学生代码生成的像素矩阵
- **判题逻辑**：矩阵内容精确匹配
- **展示方式**：可视化像素画布对比

#### 音乐类游戏（music）
- **期望结果**：预定义的音乐事件序列
- **实际结果**：学生代码生成的音乐事件
- **判题逻辑**：事件序列精确匹配
- **展示方式**：音乐序列对比展示

#### 迷宫类游戏（maze）
- **期望结果**：到达终点的路径
- **实际结果**：学生代码控制的角色路径
- **判题逻辑**：是否成功到达终点且步数合规
- **展示方式**：迷宫路径可视化

#### LED类游戏（led）
- **期望结果**：预定义的LED状态序列
- **实际结果**：学生代码控制的LED状态
- **判题逻辑**：LED状态序列精确匹配
- **展示方式**：LED状态对比展示

### 🌐 多语言与文案规范

- 默认展示语言为**简体中文**，所有关卡字段（`title`、`story`、`goals`、`hints`、`rewards.badges` 等）以及 manifest 中的 `packs`、`games` 描述都需提供自然流畅的中文文案。  
- 如需保留英文或专业术语，可在中文后括号标注示例，例如“输出 Hello, Island!（英文问候语）”。  
- 判题提示、运行错误消息、按钮文本等 UI 文案同样遵循中文优先；若未来接入 i18n，须在配置中同步维护对应翻译键值。  
- 新增或修改关卡后，请运行 `node tools/generate-manifest.js` 重新生成 manifest，确保中文文案同步至学生端展示。

### 4. 下一关按钮显示逻辑

根据代码分析，下一关按钮的显示遵循以下原则：

```typescript
// 在RunPanel.tsx中
{result?.judge?.passed && nextLevelId && onGoNext && (
  <div className="通关庆祝界面">
    <button className="btn btn-cta" onClick={onGoNext}>
      进入下一关 →
    </button>
  </div>
)}
```

**显示条件**：
1. ✅ `result.judge.passed === true`（判题通过）
2. ✅ `nextLevelId`存在（有下一关）
3. ✅ `onGoNext`回调函数存在

**判题通过标准**：
- I/O类：`testCase.actual === testCase.expected`
- 事件类：`eventCase.passed === true`
- 结构验证：`result.structure.valid === true`（如适用）

### 5. 关卡难度设计指南

#### 初级关卡（1-3关）
- **目标**：掌握基础语法和概念
- **示例**：变量、循环、条件判断、函数定义
- **代码长度**：5-15行
- **经验值**：10-20 XP

#### 中级关卡（4-6关）
- **目标**：综合应用多个概念
- **示例**：嵌套循环、数组操作、字符串处理
- **代码长度**：15-30行
- **经验值**：20-35 XP

#### 高级关卡（7-9关）
- **目标**：解决复杂问题
- **示例**：算法实现、数据结构、递归
- **代码长度**：30-50行
- **经验值**：35-50 XP

#### 挑战关卡（10关）
- **目标**：创新思维和优化
- **示例**：多种解法、性能优化、边界情况处理
- **代码长度**：50+行
- **经验值**：50-100 XP

### 6. 测试用例设计原则

1. **边界测试**：包含边界值和异常情况
2. **多组测试**：至少3组不同的输入输出
3. **逐步提示**：错误时给出具体提示信息
4. **性能考虑**：测试用例应在规定时间内完成

### 7. 学习提示设计

1. **渐进式**：从简单提示到详细解释
2. **代码示例**：提供关键代码片段
3. **常见错误**：指出常见错误和解决方法
4. **扩展思考**：鼓励进一步优化和探索

### 8. 奖励系统设计

- **经验值（XP）**：用于等级提升和技能解锁
- **金币（Coins）**：用于购买提示和解锁内容
- **徽章（Badges）**：特殊成就和里程碑奖励

### 9. 质量检查清单

创建新关卡时，必须检查：

- [ ] 关卡ID唯一且格式正确
- [ ] 标题简洁有吸引力
- [ ] 故事情境化且相关
- [ ] 目标明确且可测量
- [ ] 初始代码包含TODO注释
- [ ] 测试用例覆盖主要场景
- [ ] 期望结果和实际结果对比清晰
- [ ] 难度评级准确
- [ ] 奖励配置合理
- [ ] 学习提示有用且完整

### 10. 实施要求

此设计原则为**强制性要求**，所有新关卡必须严格遵守。建议在项目根目录创建`LEVEL_DESIGN_REQUIREMENTS.md`文件，确保该原则不会被遗忘或忽视。

**关键提醒**：
- 每个游戏必须有**恰好10个关卡**
- 每个关卡必须有**期望结果、实际结果、答案**元素
- 只有期望结果和实际结果匹配时，才显示**下一关按钮**
- 所有关卡必须通过`npm run levels:check`验证
