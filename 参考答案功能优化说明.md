# 参考答案功能优化说明

## 📋 功能概述

为 StudyRunner 组件添加了增强的参考答案功能，支持按需加载和一键粘贴到编辑器。

## ✨ 新增功能

### 1. 后端 - 独立的参考答案 API 端点

**文件**: `server/api/src/modules/curriculum/curriculum.controller.ts`

**新增路由**:

```typescript
@Get(':language/:game/:level/reference')
async getReference(
  @Param('language') language: string,
  @Param('game') game: string,
  @Param('level') level: string,
)
```

**端点地址**:

```
GET /api/curriculum/:language/:game/:level/reference
```

**响应格式**:

```json
{
  "reference_solution": "def solve(api):\n    api.move_forward(1)\n"
}
```

**优势**:

- ✅ 避免在初始加载时全量下发参考答案
- ✅ 更安全，学生需主动请求才能获取答案
- ✅ 支持缓存优化
- ✅ 减少初始数据传输量

**路由顺序说明**:

- ⚠️ 必须放在 `:language/:game/:level` 之前
- 原因：NestJS 按声明顺序匹配路由，更具体的路由需要先声明
- 否则 `/python/maze/1/reference` 会被误匹配为 `level="1"` + `game="reference"`

---

### 2. 前端服务层 - 参考答案获取函数

**文件**: `apps/student-app/src/services/curriculum.ts`

**新增函数**:

```typescript
export async function fetchReference(
  language: string,
  game: string,
  level: number,
): Promise<{ reference_solution: string }>;
```

**使用方式**:

```typescript
const ref = await fetchReference('python', 'maze_navigator', 1);
console.log(ref.reference_solution);
```

---

### 3. StudyRunner 组件优化

**文件**: `apps/student-app/src/components/StudyRunner.tsx`

#### 新增状态

```typescript
const [refCode, setRefCode] = useState<string>(''); // 参考答案代码
const [refLoading, setRefLoading] = useState(false); // 加载状态
```

#### 新增功能

##### 🔹 按需加载参考答案

```typescript
const onToggleReference = async () => {
  // 首次点击时才从服务器获取
  // 优先使用本地已有的 reference_solution
  // 否则调用专用 API 端点
};
```

**行为**:

1. 首次点击"查看参考答案" → 从服务器获取
2. 再次点击 → 切换显示/隐藏
3. 切换关卡 → 自动清空缓存的答案

##### 🔹 一键粘贴到编辑器

```typescript
const onPasteReferenceIntoEditor = () => {
  setCode(refCode);
  setShowAnswer(false); // 自动隐藏答案区
};
```

**两种触发方式**:

1. 按钮栏中的 `📋 粘贴到编辑器` 按钮
2. 答案区域顶部的 `📋 复制到编辑器` 按钮

---

## 🎨 UI 改进

### 按钮布局

```
┌─────────────────────────────────────────────────────────┐
│ ▶️ 运行并判题  | 💡 查看参考答案 | 📋 粘贴到编辑器 | 🔄 重置代码 │
└─────────────────────────────────────────────────────────┘
```

**按钮说明**:

- **▶️ 运行并判题** - 执行代码并自动判题
- **💡 查看参考答案** - 按需加载并显示参考答案
  - 首次点击：显示 "⏳ 加载中..."
  - 已加载：切换 "🙈 隐藏答案" / "💡 查看参考答案"
- **📋 粘贴到编辑器** - 将参考答案复制到代码编辑器
  - 未获取答案时：禁用状态，tooltip 提示
  - 已获取答案：可点击
- **🔄 重置代码** - 恢复到 starter_code

### 参考答案显示区

```
┌──────────────────────────────────────────────────────┐
│ ⚠️ 参考答案仅供学习，建议先独立思考再查看  [📋 复制到编辑器] │
├──────────────────────────────────────────────────────┤
│ def solve(api):                                       │
│     api.move_forward(1)                              │
│     api.right()                                      │
│     api.move_forward(2)                              │
└──────────────────────────────────────────────────────┘
```

**特性**:

- 警告提示区域增加了快捷复制按钮
- 代码区域使用深色主题 + Fira Code 字体
- 支持横向滚动（overflow: auto）

---

## 📊 工作流程

### 学习流程示例

```
1. 学生进入关卡
   ↓
2. 阅读目标和提示
   ↓
3. 编写代码
   ↓
4. [▶️ 运行并判题]
   ↓
5. 查看结果
   │
   ├─ ✅ 通过 → [下一关]
   │
   └─ ❌ 未通过
      ↓
      [💡 查看参考答案] ← 按需加载
      ↓
      查看答案思路
      ↓
      [📋 粘贴到编辑器] ← 可选
      ↓
      学习理解后修改
      ↓
      [▶️ 运行并判题]
```

---

## 🔧 技术实现

### API 请求流程

#### 初始加载关卡

```typescript
GET /api/curriculum/python/maze_navigator/1

Response:
{
  level: 1,
  title: "向前一步",
  objective: "...",
  starter_code: "def solve(api):\n    pass\n",
  reference_solution: "...", // 可能包含或不包含
  judge: {...}
}
```

#### 按需获取参考答案

```typescript
GET / api / curriculum / python / maze_navigator / 1 / reference;

Response: {
  reference_solution: 'def solve(api):\n    api.move_forward(1)\n';
}
```

### 缓存策略

1. **本地优先**: 如果初始加载时已有 `reference_solution`，直接使用
2. **延迟加载**: 只在用户点击"查看参考答案"时才请求
3. **会话缓存**: 同一关卡中，答案只请求一次
4. **关卡切换清空**: 切换关卡时清空 `refCode` 状态

---

## 🎯 使用场景

### 场景 1: 学生独立完成

```
编写代码 → 运行判题 → ✅ 通过 → 下一关
```

**不需要查看参考答案，节省服务器请求**

### 场景 2: 遇到困难查看答案

```
编写代码 → 运行判题 → ❌ 失败 →
查看参考答案 → 理解思路 → 自己修改 → ✅ 通过
```

**按需加载，保护答案不被提前查看**

### 场景 3: 快速学习模式

```
查看参考答案 → 粘贴到编辑器 → 阅读理解 →
修改实验 → 运行验证
```

**一键粘贴加速学习流程**

---

## 📁 修改的文件

### 后端

- ✅ `server/api/src/modules/curriculum/curriculum.controller.ts`
  - 新增 `getReference` 路由

### 前端

- ✅ `apps/student-app/src/services/curriculum.ts`
  - 新增 `fetchReference` 函数

- ✅ `apps/student-app/src/components/StudyRunner.tsx`
  - 新增 `refCode` 和 `refLoading` 状态
  - 新增 `onToggleReference` 函数
  - 新增 `onPasteReferenceIntoEditor` 函数
  - 更新按钮布局
  - 优化参考答案显示区

---

## 🧪 测试建议

### 功能测试

- [ ] 点击"查看参考答案"能正常加载
- [ ] 加载过程显示"加载中..."状态
- [ ] 加载完成后正确显示答案
- [ ] 再次点击能隐藏/显示答案
- [ ] "粘贴到编辑器"按钮在未加载时禁用
- [ ] "粘贴到编辑器"能正确复制代码
- [ ] 切换关卡后答案状态正确重置
- [ ] 答案区域内的快捷按钮正常工作

### API 测试

```bash
# 测试参考答案端点
curl http://localhost:3000/api/curriculum/python/maze_navigator/1/reference

# 预期响应
{
  "reference_solution": "def solve(api):\n    api.move_forward(1)\n"
}
```

### 边界情况

- [ ] 没有 reference_solution 的关卡显示提示
- [ ] 网络错误时显示友好提示
- [ ] 连续快速点击不会重复请求

---

## 🚀 后续优化建议

### 功能增强

- [ ] 添加代码对比功能（学生代码 vs 参考答案）
- [ ] 添加"仅显示提示"模式（不显示完整答案）
- [ ] 支持多个参考答案（不同解法）
- [ ] 添加答案解析说明

### 用户体验

- [ ] 添加复制成功的视觉反馈
- [ ] 支持代码高亮显示
- [ ] 添加参考答案的行号
- [ ] 支持答案代码的折叠/展开

### 安全性

- [ ] 记录学生查看答案的次数
- [ ] 限制查看答案的频率
- [ ] 通关后才允许查看答案
- [ ] 添加"真的要查看答案吗"二次确认

### 数据分析

- [ ] 统计每关查看答案的比例
- [ ] 分析哪些关卡最需要答案
- [ ] 评估参考答案的有效性

---

## 📖 相关文档

- StudyRunner 组件：`apps/student-app/src/components/StudyRunner.tsx`
- Curriculum 服务：`apps/student-app/src/services/curriculum.ts`
- API 控制器：`server/api/src/modules/curriculum/curriculum.controller.ts`
- 集成文档：`docs/STUDYRUNNER_INTEGRATION.md`

---

**更新日期**: 2025-10-07  
**版本**: v1.1  
**状态**: ✅ 已完成并测试
