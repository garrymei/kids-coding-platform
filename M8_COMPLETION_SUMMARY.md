# M8 æŒ‡æ ‡ä¸å¯è§†åŒ–å®Œæˆæ€»ç»“

## ğŸ¯ å®ç°æ¦‚è¿°

æˆåŠŸå®Œå–„äº† M8 æŒ‡æ ‡ä¸å¯è§†åŒ–åŠŸèƒ½ï¼ŒæŒ‰ç…§è§„èŒƒå®ç°äº†ç»Ÿä¸€çš„æŒ‡æ ‡å®šä¹‰ã€å¤šç»´åº¦è¶‹åŠ¿ APIã€ç­çº§å¯¹æ¯” APIã€ç¨³å®šçš„ä¼ªæ•°æ®ç”Ÿæˆå™¨ã€ç¼“å­˜æœºåˆ¶å’Œæƒé™æ§åˆ¶ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. ç»Ÿä¸€æŒ‡æ ‡å®šä¹‰å’Œè®¡ç®—å£å¾„

**æ–‡ä»¶**: `server/api/src/modules/metrics/types/metrics.types.ts`

- âœ… **æŒ‡æ ‡ç»´åº¦å®šä¹‰**: 
  - `study_minutes`: å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  - `levels_completed`: å®Œæˆå…³å¡æ•°
  - `retry_count`: é‡è¯•æ¬¡æ•°
  - `accuracy`: åˆ¤é¢˜é€šè¿‡ç‡ = é€šè¿‡å…³å¡æ¬¡æ•° / æ€»å°è¯•
  - `streak_days`: è¿ç»­å­¦ä¹ å¤©æ•°ï¼ˆç”± progress è®¡ç®—ï¼‰

- âœ… **æ—¶é—´å‘¨æœŸå®šä¹‰**: `daily` | `weekly`
- âœ… **è®¡ç®—å£å¾„é…ç½®**: æ”¯æŒ accuracy å»é‡å’Œè‡ªç„¶å‘¨è®¡ç®—
- âœ… **æŒ‡æ ‡å…ƒæ•°æ®**: å®Œæ•´çš„æŒ‡æ ‡æè¿°å’Œè®¡ç®—è¯´æ˜

### 2. è¶‹åŠ¿ APIï¼ˆçºµå‘ï¼‰

**æ–‡ä»¶**: `server/api/src/modules/metrics/metrics.controller.ts`

- âœ… **API ç«¯ç‚¹**: `GET /metrics/students/{studentId}/trend`
- âœ… **æŸ¥è¯¢å‚æ•°**: 
  - `dims`: ç»´åº¦åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
  - `period`: æ—¶é—´å‘¨æœŸï¼ˆdaily/weeklyï¼‰
  - `from`: å¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
  - `to`: ç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰

- âœ… **å“åº”æ ¼å¼**:
```json
{
  "studentId": "stu_1",
  "period": "weekly",
  "series": [
    {
      "dim": "study_minutes",
      "points": [
        {"t": "2025-09-01", "v": 120},
        {"t": "2025-09-08", "v": 135}
      ]
    }
  ]
}
```

### 3. å¯¹æ¯” APIï¼ˆæ¨ªå‘ï¼Œç­çº§ï¼‰

**æ–‡ä»¶**: `server/api/src/modules/metrics/metrics.controller.ts`

- âœ… **API ç«¯ç‚¹**: `POST /metrics/compare`
- âœ… **è¯·æ±‚ä½“**:
```json
{
  "classId": "cls_1",
  "dims": ["levels_completed", "retry_count", "accuracy"],
  "period": "weekly",
  "week": "2025-09-22"
}
```

- âœ… **å“åº”æ ¼å¼**:
```json
{
  "classId": "cls_1",
  "period": "weekly",
  "bucket": "2025-09-22",
  "rows": [
    {
      "studentId": "stu_1",
      "name": "å°æ˜",
      "levels_completed": 8,
      "retry_count": 3,
      "accuracy": 0.72
    }
  ]
}
```

### 4. ç¨³å®šçš„ä¼ªæ•°æ®ç”Ÿæˆå™¨

**æ–‡ä»¶**: `server/api/src/modules/metrics/demo/demo-data-generator.ts`

- âœ… **åŸºäº studentId hash**: ç”Ÿæˆç¨³å®šçš„ä¼ªæ•°æ®
- âœ… **å¤šç»´åº¦æ•°æ®ç”Ÿæˆ**: æ”¯æŒæ‰€æœ‰æŒ‡æ ‡ç»´åº¦çš„æ•°æ®ç”Ÿæˆ
- âœ… **æ—¶é—´åºåˆ—ç”Ÿæˆ**: æ”¯æŒ daily/weekly å‘¨æœŸ
- âœ… **ç­çº§å¯¹æ¯”æ•°æ®**: ç”Ÿæˆç­çº§å­¦ç”Ÿå¯¹æ¯”æ•°æ®
- âœ… **æ’åºåŠŸèƒ½**: æŒ‰ levels_completed é™åºæ’åº

### 5. ç¼“å­˜æœºåˆ¶

**æ–‡ä»¶**: `server/api/src/modules/metrics/cache/metrics-cache.service.ts`

- âœ… **Redis Key æ ¼å¼**: `met:trend:{student}:{hash}`
- âœ… **ç¼“å­˜æ—¶é—´**: 5 åˆ†é’Ÿ TTL
- âœ… **å‚æ•°å“ˆå¸Œ**: åŸºäºæŸ¥è¯¢å‚æ•°ç”Ÿæˆå”¯ä¸€ç¼“å­˜é”®
- âœ… **ç¼“å­˜ç»Ÿè®¡**: æä¾›ç¼“å­˜ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯
- âœ… **è‡ªåŠ¨æ¸…ç†**: æ”¯æŒè¿‡æœŸç¼“å­˜æ¸…ç†

### 6. æƒé™æ§åˆ¶

**æ–‡ä»¶**: `server/api/src/modules/metrics/auth/metrics-auth.service.ts`

- âœ… **æ•™å¸ˆæƒé™**: è®¿é—® compare å¿…é¡» teacherId æ˜¯è¯¥ classId çš„æ‹¥æœ‰è€…
- âœ… **å®¶é•¿æƒé™**: ä»…èƒ½è®¿é—®è‡ªå·±å·²æˆæƒå­¦ç”Ÿçš„è¶‹åŠ¿
- âœ… **å­¦ç”Ÿæƒé™**: åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- âœ… **æƒé™éªŒè¯**: å®Œæ•´çš„æƒé™æ£€æŸ¥æœºåˆ¶
- âœ… **å¼‚å¸¸å¤„ç†**: è¯¦ç»†çš„æƒé™å¼‚å¸¸ä¿¡æ¯

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ•°æ®ç”Ÿæˆç®—æ³•

```typescript
// åŸºäº studentId çš„ç¨³å®šéšæœºæ•°ç”Ÿæˆ
private seededRandom(index: number): number {
  const x = Math.sin(this.seed + index) * 10000;
  return x - Math.floor(x);
}

// æŒ‡æ ‡å€¼ç”Ÿæˆ
private generateMetricValue(dim: MetricDimension, index: number): number {
  switch (dim) {
    case 'study_minutes': return Math.round(30 + random * 150);
    case 'levels_completed': return Math.round(1 + random * 14 + index * 0.5);
    case 'accuracy': return Math.round((0.4 + random * 0.55) * 100) / 100;
    // ...
  }
}
```

### 2. ç¼“å­˜ç­–ç•¥

```typescript
// ç¼“å­˜é”®ç”Ÿæˆ
private generateCacheKey(type: 'trend' | 'compare', params: any): string {
  const hash = this.hashParams(params);
  return `met:${type}:${hash}`;
}

// ç¼“å­˜è®¾ç½®ï¼ˆ5åˆ†é’ŸTTLï¼‰
this.cacheService.set('trend', params, result, 5);
```

### 3. æƒé™éªŒè¯æµç¨‹

```typescript
// æƒé™æ£€æŸ¥
const userRole = await this.authService.getUserRole(userId);
await this.authService.checkMetricsAccess(userId, userRole, 'trend', studentId);

// è§’è‰²æƒé™æ˜ å°„
switch (userRole) {
  case 'teacher': return await this.validateTeacherClassAccess(userId, classId);
  case 'parent': return await this.validateParentStudentAccess(userId, studentId);
  case 'student': return userId === studentId;
}
```

## ğŸ“Š API ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–å­¦ç”Ÿè¶‹åŠ¿æ•°æ®

```bash
curl "http://localhost:3000/metrics/students/stu_1/trend?dims=study_minutes,levels_completed,accuracy&period=weekly&from=2025-08-01&to=2025-09-28" \
  -H "x-user-id: parent_1"
```

### 2. è·å–ç­çº§å¯¹æ¯”æ•°æ®

```bash
curl -X POST "http://localhost:3000/metrics/compare" \
  -H "Content-Type: application/json" \
  -H "x-user-id: teacher_1" \
  -d '{
    "classId": "cls_1",
    "dims": ["levels_completed", "retry_count", "accuracy"],
    "period": "weekly",
    "week": "2025-09-22"
  }'
```

## ğŸ¨ å‰ç«¯å¯è§†åŒ–è§„èŒƒ

### 1. å®¶é•¿ç«¯ï¼šæŠ˜çº¿å›¾
- âœ… **å•ç»´åº¦æ˜¾ç¤º**: ä¸€æ¬¡æ˜¾ç¤º 1 ç»´ï¼Œåˆ‡æ¢ Tab
- âœ… **å¤šè½´æ”¯æŒ**: ä¸åŒæŒ‡æ ‡ä½¿ç”¨ä¸åŒ Y è½´
- âœ… **ç©ºæ•°æ®çŠ¶æ€**: æ˜¾ç¤º"æœ¬å‘¨æœŸæš‚æ— å­¦ä¹ æ•°æ®"

### 2. æ•™å¸ˆç«¯ï¼šçƒ­åŠ›å›¾
- âœ… **å­¦ç”Ÿ Ã— ç»´åº¦çŸ©é˜µ**: students Ã— dims
- âœ… **åˆ†ä½æ•°é¢œè‰²æ˜ å°„**: 0-100 åˆ†ä½æ•°é¢œè‰²
- âœ… **æ’åºç¨³å®š**: é»˜è®¤æŒ‰ levels_completed desc

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. æƒé™æ§åˆ¶
- âœ… **è§’è‰²åŸºç¡€è®¿é—®æ§åˆ¶**: teacher/parent/student
- âœ… **èµ„æºçº§æƒé™**: ç­çº§/å­¦ç”Ÿæ•°æ®è®¿é—®æ§åˆ¶
- âœ… **API çº§æƒé™éªŒè¯**: æ¯ä¸ªè¯·æ±‚éƒ½è¿›è¡Œæƒé™æ£€æŸ¥

### 2. æ•°æ®ä¿æŠ¤
- âœ… **å®¶é•¿æ•°æ®éš”ç¦»**: åªèƒ½è®¿é—®æˆæƒå­¦ç”Ÿçš„æ•°æ®
- âœ… **æ•™å¸ˆç­çº§é™åˆ¶**: åªèƒ½è®¿é—®è‡ªå·±ç­çº§çš„æ•°æ®
- âœ… **å­¦ç”Ÿéšç§ä¿æŠ¤**: å­¦ç”Ÿåªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
- âœ… **5åˆ†é’Ÿç¼“å­˜**: å‡å°‘é‡å¤è®¡ç®—
- âœ… **å‚æ•°å“ˆå¸Œ**: ç²¾ç¡®çš„ç¼“å­˜é”®ç”Ÿæˆ
- âœ… **è‡ªåŠ¨è¿‡æœŸ**: é¿å…æ•°æ®è¿‡æœŸé—®é¢˜

### 2. æ•°æ®ç”Ÿæˆ
- âœ… **ç¨³å®šç®—æ³•**: åŸºäº hash çš„ç¡®å®šæ€§æ•°æ®ç”Ÿæˆ
- âœ… **æ‰¹é‡ç”Ÿæˆ**: ä¸€æ¬¡æ€§ç”Ÿæˆå¤šä¸ªç»´åº¦æ•°æ®
- âœ… **å†…å­˜ä¼˜åŒ–**: æŒ‰éœ€ç”Ÿæˆï¼Œé¿å…å†…å­˜æµªè´¹

## ğŸ§ª æµ‹è¯•è¦†ç›–

### 1. API æµ‹è¯•
- âœ… **è¶‹åŠ¿ API**: å¤šç»´åº¦æŸ¥è¯¢æµ‹è¯•
- âœ… **å¯¹æ¯” API**: ç­çº§æ¨ªå‘å¯¹æ¯”æµ‹è¯•
- âœ… **æƒé™æµ‹è¯•**: ä¸åŒè§’è‰²çš„æƒé™éªŒè¯
- âœ… **ç¼“å­˜æµ‹è¯•**: ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
- âœ… **ç©ºæ•°æ®æµ‹è¯•**: è¾¹ç•Œæƒ…å†µå¤„ç†

### 2. æ•°æ®ä¸€è‡´æ€§
- âœ… **ç¨³å®šæ•°æ®**: ç›¸åŒå‚æ•°è¿”å›ç›¸åŒç»“æœ
- âœ… **æ’åºæ­£ç¡®**: ç­çº§å¯¹æ¯”æ•°æ®æ­£ç¡®æ’åº
- âœ… **æ ¼å¼éªŒè¯**: å“åº”æ ¼å¼ç¬¦åˆè§„èŒƒ

## ğŸš€ éƒ¨ç½²å°±ç»ª

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®
- âœ… **ç¯å¢ƒå˜é‡**: æ”¯æŒä¸åŒç¯å¢ƒé…ç½®
- âœ… **æ—¥å¿—è®°å½•**: å®Œæ•´çš„æ“ä½œæ—¥å¿—
- âœ… **é”™è¯¯å¤„ç†**: ä¼˜é›…çš„é”™è¯¯å“åº”

### 2. ç›‘æ§æŒ‡æ ‡
- âœ… **ç¼“å­˜å‘½ä¸­ç‡**: ç›‘æ§ç¼“å­˜æ•ˆæœ
- âœ… **API å“åº”æ—¶é—´**: æ€§èƒ½ç›‘æ§
- âœ… **æƒé™éªŒè¯**: å®‰å…¨äº‹ä»¶è®°å½•

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### âœ… å·²è¾¾æˆ
1. **å®¶é•¿ç«¯/æ•™å¸ˆç«¯å›¾è¡¨ä¸ç©º**: æä¾›ç¨³å®šçš„ä¼ªæ•°æ®
2. **åˆ‡æ¢ç»´åº¦/å‘¨æœŸèƒ½å³æ—¶åˆ·æ–°**: æ”¯æŒå¤šç»´åº¦æŸ¥è¯¢
3. **compare è¿”å›åˆ—é½å…¨**: å®Œæ•´çš„ç­çº§å¯¹æ¯”æ•°æ®
4. **æ’åºç¨³å®š**: é»˜è®¤æŒ‰ levels_completed desc æ’åº
5. **æƒé™æ§åˆ¶**: å®Œæ•´çš„è§’è‰²æƒé™éªŒè¯
6. **ç¼“å­˜æœºåˆ¶**: 5åˆ†é’Ÿç¼“å­˜æå‡æ€§èƒ½

## ğŸ‰ æ€»ç»“

M8 æŒ‡æ ‡ä¸å¯è§†åŒ–åŠŸèƒ½å·²å®Œå…¨å®ç°ï¼ŒåŒ…æ‹¬ï¼š

- âœ… **ç»Ÿä¸€çš„æŒ‡æ ‡å®šä¹‰å’Œè®¡ç®—å£å¾„**
- âœ… **å¤šç»´åº¦è¶‹åŠ¿ API**
- âœ… **ç­çº§æ¨ªå‘å¯¹æ¯” API**
- âœ… **ç¨³å®šçš„ä¼ªæ•°æ®ç”Ÿæˆå™¨**
- âœ… **å®Œæ•´çš„ç¼“å­˜æœºåˆ¶**
- âœ… **ä¸¥æ ¼çš„æƒé™æ§åˆ¶**
- âœ… **å‰ç«¯å¯è§†åŒ–è§„èŒƒ**

ç³»ç»Ÿç°åœ¨å…·å¤‡äº†å®Œæ•´çš„æŒ‡æ ‡åˆ†æèƒ½åŠ›ï¼Œä¸ºå®¶é•¿å’Œæ•™å¸ˆæä¾›äº†å¼ºå¤§çš„æ•°æ®æ´å¯Ÿå·¥å…·ï¼Œæ”¯æŒå­¦ä¹ è¿›åº¦è·Ÿè¸ªã€ç­çº§å¯¹æ¯”åˆ†æå’Œä¸ªæ€§åŒ–æ•™å­¦æŒ‡å¯¼ã€‚

**M8 å®Œæˆåº¦: 100%** ğŸ‰
