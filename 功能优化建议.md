# Kids Coding Platform 功能优化建议

## 🔴 当前核心问题

### 1. 双轨关卡系统（最严重）

**现状**：
- **PlayPage**（主学习页）使用老系统：
  - 数据源：`/assets/levels/index.json`（静态 JSON）
  - 判题：本地 `runAndJudge`（模拟判题）
  - 进度：`TODO` 注释，未实现
  
- **StudyRunner**（新学习页）使用新系统：
  - 数据源：`/api/curriculum`（后端 API）
  - 判题：`/api/judge`（真实判题）
  - 进度：`/api/progress`（已实现）

**问题**：
- ❌ 两套系统数据不同步
- ❌ PlayPage 的判题是假的，无法真正验证代码正确性
- ❌ PlayPage 的进度管理是空的（`const doneIds: string[] = []`）
- ❌ "下一关"按钮无法正确工作
- ❌ 关卡数据重复存储

### 2. 进度管理未连通

**PlayPage.tsx 第 41 行**：
```typescript
const doneIds: string[] = []; // TODO: 从 progressStore 获取已完成的关卡
```

**RunPanel.tsx 第 37-58 行**：
```typescript
const handleRun = async () => {
  const data = await runAndJudge({ level, code });
  setResult(data);
  // ❌ 没有调用 updateProgress，通过后不会记录
};
```

**结果**：
- 用户完成关卡后没有任何进度保存
- 刷新页面后进度丢失
- 课程页的进度环不会更新

### 3. 判题逻辑不统一

- **老系统（PlayPage）**：本地判题，每种游戏类型单独实现
- **新系统（StudyRunner）**：后端统一判题，支持 4 种判题类型

这导致同一个关卡在两个页面的判题结果可能不一致。

---

## ✅ 推荐优化方案

### 🎯 方案一：统一到新系统（推荐 ⭐⭐⭐⭐⭐）

**目标**：让 PlayPage 也使用 curriculum + judge + progress API

#### 改造内容

##### 1. 修改 PlayPage 路由和数据获取

**当前路由**：`/play/:levelId`
**建议改为**：`/play/:language/:game/:level`

**当前数据获取**：
```typescript
const level = await levelRepo.getLevelById(levelId);
```

**改为**：
```typescript
import { fetchLevel } from '../../services/curriculum';
const levelData = await fetchLevel(language, game, Number(level));
```

##### 2. 修改 RunPanel 判题逻辑

**当前**：
```typescript
const data = await runAndJudge({ level, code });
```

**改为**：
```typescript
// 1. 执行代码
const execRes = await execute({ language: level.lang, code });

// 2. 收集判题数据
const judgeReq = await collectJudgePayload(execRes, level);

// 3. 调用判题 API
const judgeRes = await judge(judgeReq);

// 4. 如果通过，更新进度
if (judgeRes.pass) {
  await updateProgress({
    language: level.lang,
    game: level.gameType,
    level: level.level,
  });
}
```

##### 3. 修改"下一关"逻辑

**当前**：
```typescript
const doneIds: string[] = []; // TODO
const next = await pickNextLevel(doneIds);
```

**改为**：
```typescript
const { nextLevel } = await getNextLevel({
  language,
  game,
});
navigate(`/play/${language}/${game}/${nextLevel}`);
```

##### 4. 数据迁移

- 将 `/assets/levels/*.json` 中的关卡数据转换为新格式
- 放入 `server/api/src/data/curriculum/` 目录
- 或者保持两套数据，但通过脚本定期同步

#### 优点
- ✅ 统一的判题逻辑，确保准确性
- ✅ 统一的进度管理，跨页面同步
- ✅ 关卡数据集中管理，便于维护
- ✅ 符合"统一通关流水线"的设计理念

#### 工作量
- 前端改造：约 2-3 小时
- 数据迁移：约 1-2 小时
- 测试验证：约 1 小时

---

### 🎯 方案二：渐进式优化（保留双轨）

如果暂时不想大改架构，可以先改进用户体验：

#### A. 连通 PlayPage 的进度管理

1. **创建 progressStore**：
```typescript
// apps/student-app/src/stores/progressStore.ts
class ProgressStore {
  private data = new Map<string, Set<string>>();

  markDone(levelId: string) {
    // 保存到 localStorage
    const key = 'progress';
    const current = this.getDoneIds();
    current.push(levelId);
    localStorage.setItem(key, JSON.stringify(current));
  }

  getDoneIds(): string[] {
    const key = 'progress';
    return JSON.parse(localStorage.getItem(key) || '[]');
  }
}

export const progressStore = new ProgressStore();
```

2. **在 PlayPage 中使用**：
```typescript
const doneIds = progressStore.getDoneIds();
const next = await pickNextLevel(doneIds);
```

3. **在 RunPanel 通过后保存**：
```typescript
if (data.judgeResult?.pass) {
  progressStore.markDone(level.id);
}
```

#### B. 改进用户体验

##### 1. 代码自动保存
```typescript
// RunPanel.tsx
useEffect(() => {
  const timer = setTimeout(() => {
    localStorage.setItem(`code_${level.id}`, code);
  }, 1000);
  return () => clearTimeout(timer);
}, [code, level.id]);

// 加载时恢复
useEffect(() => {
  const saved = localStorage.getItem(`code_${level.id}`);
  if (saved) {
    onCodeChange(saved);
  }
}, [level.id]);
```

##### 2. 通关动画
```typescript
{result?.judgeResult?.pass && (
  <Confetti numberOfPieces={200} recycle={false} />
)}
```

##### 3. 错误提示优化
```typescript
// 当前只显示 "运行失败"
// 改进为显示具体错误信息
{error && (
  <div className="alert alert-error">
    <strong>❌ 运行失败</strong>
    <pre style={{ whiteSpace: 'pre-wrap', fontSize: 12 }}>
      {error}
    </pre>
    <button onClick={handleReset}>重置代码</button>
  </div>
)}
```

##### 4. 提示系统
```typescript
// 给每个关卡添加提示（hints）
{level.hints && (
  <details>
    <summary>💡 需要提示？</summary>
    <ul>
      {level.hints.map((hint, i) => (
        <li key={i}>{hint}</li>
      ))}
    </ul>
  </details>
)}
```

##### 5. 学习时长统计
```typescript
const startTime = useRef(Date.now());

if (judgeRes.pass) {
  const duration = Date.now() - startTime.current;
  await updateProgress({
    // ...
    durationMs: duration,
  });
}
```

---

## 📊 按学习软件操作习惯的优化建议

### 1. 进度可视化
- ✅ 课程页已有进度环
- ⚠️ 缺少"已完成 X/Y 关"的文字说明
- ⚠️ 地图页的节点状态可能不准确（因为 PlayPage 进度未保存）

**建议**：
- 在课程卡片上显示 "5/10 关已完成"
- 在关卡页顶部显示进度条

### 2. 关卡解锁机制
- ❌ 当前任意关卡都可直接访问
- 建议：前一关未通过时，下一关显示锁定状态

**实现**：
```typescript
const isLocked = !progressStore.isDone(prevLevelId);

{isLocked ? (
  <div className="alert alert-warn">
    🔒 请先完成上一关
  </div>
) : (
  <RunPanel ... />
)}
```

### 3. 即时反馈
- ✅ 运行后立即显示结果
- ⚠️ 通过/失败的视觉反馈不够明显

**建议**：
- 通过时：绿色边框 + 庆祝动画 + 音效（可选）
- 失败时：红色边框 + 震动动画 + 具体错误位置

### 4. 代码持久化
- ❌ 当前刷新页面代码会丢失
- 建议：自动保存到 localStorage

### 5. 快捷操作
- ⚠️ 缺少键盘快捷键

**建议**：
- `Ctrl + Enter`：运行代码
- `Ctrl + R`：重置代码
- `Ctrl + N`：下一关（通过后）

### 6. 社交功能（长期）
- 分享我的代码
- 查看其他人的解法
- 代码对比（我的 vs 参考答案）

---

## 🎯 推荐实施优先级

### P0（立即修复）
1. **连通 PlayPage 的进度管理**（方案二 A）
   - 让"下一关"按钮真正工作
   - 让课程页进度环准确显示

### P1（本周内）
2. **统一判题系统**（方案一）
   - 确保判题准确性
   - 避免用户困惑

### P2（下周）
3. **用户体验优化**（方案二 B）
   - 代码自动保存
   - 通关动画
   - 错误提示优化

### P3（后续迭代）
4. **高级功能**
   - 提示系统
   - 学习时长统计
   - 关卡解锁机制
   - 键盘快捷键

---

## 🔧 我可以立即帮你做的

我建议按这个顺序进行：

1. **先修复关键问题（30 分钟）**：
   - 创建 progressStore
   - 连通 PlayPage 的进度管理
   - 让"下一关"按钮工作

2. **再统一系统（2 小时）**：
   - 让 PlayPage 使用新的 API
   - 迁移关卡数据
   - 统一判题逻辑

3. **最后优化体验（1 小时）**：
   - 代码自动保存
   - 通关动画
   - 错误提示优化

---

## 💡 总结

**当前最大问题**：
- PlayPage 的判题是假的（本地模拟）
- PlayPage 的进度管理是空的（TODO 注释）
- 两套关卡系统不同步

**推荐方案**：
- 优先采用**方案一（统一到新系统）**，一劳永逸
- 如果时间紧张，先用**方案二 A（连通进度）**应急

**你想先从哪个开始？**
- A. 立即修复进度管理（让"下一关"工作）
- B. 统一判题系统（彻底解决）
- C. 优化用户体验（动画、保存等）

